name: Integration Tests (Vitest)

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: integration-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Compose services (Postgres + LocalStack)
        run: |
          docker compose -f docker-compose.yml up -d postgres-db localstack

      - name: Wait for Postgres readiness
        run: |
          echo "Waiting for Postgres (savepoint-postgres) to be ready..."
          for i in {1..60}; do
            if docker exec savepoint-postgres pg_isready -U postgres >/dev/null 2>&1; then
              echo "Postgres is ready."; break; fi; sleep 2; done
          docker exec savepoint-postgres pg_isready -U postgres

      - name: Wait for LocalStack readiness
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
        run: |
          echo "Waiting for LocalStack S3 on http://localhost:4568 ..."
          for i in {1..60}; do
            if aws --endpoint-url=http://localhost:4568 s3 ls >/dev/null 2>&1; then
              echo "LocalStack is ready."; break; fi; sleep 2; done
          aws --endpoint-url=http://localhost:4568 s3 ls || true

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm

      - name: Install dependencies
        env:
          POSTGRES_PRISMA_URL: ${{ secrets.POSTGRES_PRISMA_URL }}
          POSTGRES_URL_NON_POOLING: ${{ secrets.POSTGRES_URL_NON_POOLING }}
        run: pnpm install --frozen-lockfile

      - name: Initialize LocalStack S3 bucket
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
        run: |
          # Create bucket if not exists (ignore error if already created)
          aws --endpoint-url=http://localhost:4568 s3 mb s3://savepoint-dev || true
          # Apply CORS from repo file (ok if not strictly required for integration)
          aws --endpoint-url=http://localhost:4568 s3api put-bucket-cors \
            --bucket savepoint-dev \
            --cors-configuration file://scripts/localstack-cors.json || true

      - name: Run integration tests (Vitest)
        working-directory: savepoint-app
        run: pnpm test:integration

      - name: Teardown Docker services
        if: always()
        run: |
          docker compose -f docker-compose.yml down -v

